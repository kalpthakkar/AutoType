<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AutoTyper Sender</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 text-gray-900 font-sans min-h-screen flex flex-col">
  <main class="w-full max-w-[900px] mx-auto p-6 bg-white shadow-lg rounded-lg mt-12 mb-12 flex-grow">
    <h1 class="text-3xl font-extrabold text-center mb-8 tracking-tight">AutoTyper Sender</h1>

    <section class="mb-8">
      <label for="codeInput" class="block mb-2 text-lg font-semibold text-gray-700">Code to Type</label>
      <textarea
        id="codeInput"
        rows="10"
        placeholder="Enter code or message here..."
        class="w-full rounded-md border border-gray-300 p-3 resize-none placeholder-gray-400
               focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500
               transition-shadow duration-200 shadow-sm"></textarea>
    </section>

    <section
      class="mb-10 max-w-md w-full mx-auto bg-white border border-gray-200 rounded-lg p-6 shadow-sm"
      aria-label="Auto Pause Settings"
    >
      <div class="flex items-center justify-between">
        <div>
          <h2 class="text-xl font-semibold text-gray-900 mb-1">Auto Pause</h2>
          <p class="text-sm text-gray-500 leading-tight">Pause automatically after each line</p>
        </div>

        <label class="relative inline-flex items-center cursor-pointer" for="autoPauseToggle">
          <input
            type="checkbox"
            id="autoPauseToggle"
            class="sr-only peer"
            onchange="toggleAutoPause()"
            aria-label="Auto Pause After Each Line"
          />
          <div
            class="w-12 h-7 bg-gray-200 rounded-full peer-checked:bg-indigo-600 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-indigo-400 transition-colors duration-200"
          ></div>
          <span
            class="absolute left-0.5 top-0.5 w-6 h-6 bg-white border border-gray-300 rounded-full shadow-md
                   transform peer-checked:translate-x-5 peer-checked:border-transparent
                   transition-transform duration-200 will-change-transform"
            aria-hidden="true"
          ></span>
        </label>
      </div>
    </section>

    <section class="mb-8 flex flex-wrap justify-center gap-4">
      <button
        id="runBtn"
        class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-md shadow-md
               focus:outline-none focus:ring-2 focus:ring-green-400 focus:ring-offset-1 transition"
      >
        Run
      </button>
      <button
        id="pauseBtn"
        class="bg-yellow-500 hover:bg-yellow-600 text-white px-6 py-2 rounded-md shadow-md
               focus:outline-none focus:ring-2 focus:ring-yellow-400 focus:ring-offset-1 transition"
      >
        Pause
      </button>
      <button
        id="randomBtn"
        class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-md shadow-md
               focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-offset-1 transition"
      >
        Random: On
      </button>
      <button
        id="stopBtn"
        class="bg-red-600 hover:bg-red-700 text-white px-6 py-2 rounded-md shadow-md
               focus:outline-none focus:ring-2 focus:ring-red-400 focus:ring-offset-1 transition"
      >
        Stop
      </button>
    </section>

    <section
      class="flex flex-wrap justify-center gap-8"
      aria-label="Cursor control commands"
    >
      <!-- Backspace -->
      <div class="flex flex-col items-center w-32">
        <label for="backspaceCount" class="block font-semibold text-gray-700 mb-1">Backspace</label>
        <div class="flex items-center w-full">
          <input
            type="number"
            id="backspaceCount"
            class="w-full border border-gray-300 rounded-l-md p-2 text-center focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
            value="1"
            min="1"
          />
          <button
            onclick="sendCursorCommand('backspace')"
            class="bg-gray-700 hover:bg-gray-800 text-white px-3 py-2 rounded-r-md transition focus:outline-none focus:ring-2 focus:ring-indigo-500"
            aria-label="Send backspace command"
          >
            Go
          </button>
        </div>
      </div>

      <!-- Left -->
      <div class="flex flex-col items-center w-32">
        <label for="leftCount" class="block font-semibold text-gray-700 mb-1">Left</label>
        <div class="flex items-center w-full">
          <input
            type="number"
            id="leftCount"
            class="w-full border border-gray-300 rounded-l-md p-2 text-center focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
            value="1"
            min="1"
          />
          <button
            onclick="sendCursorCommand('left')"
            class="bg-gray-700 hover:bg-gray-800 text-white px-3 py-2 rounded-r-md transition focus:outline-none focus:ring-2 focus:ring-indigo-500"
            aria-label="Send left command"
          >
            Go
          </button>
        </div>
      </div>

      <!-- Right -->
      <div class="flex flex-col items-center w-32">
        <label for="rightCount" class="block font-semibold text-gray-700 mb-1">Right</label>
        <div class="flex items-center w-full">
          <input
            type="number"
            id="rightCount"
            class="w-full border border-gray-300 rounded-l-md p-2 text-center focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
            value="1"
            min="1"
          />
          <button
            onclick="sendCursorCommand('right')"
            class="bg-gray-700 hover:bg-gray-800 text-white px-3 py-2 rounded-r-md transition focus:outline-none focus:ring-2 focus:ring-indigo-500"
            aria-label="Send right command"
          >
            Go
          </button>
        </div>
      </div>
    </section>
  </main>

    <script>
        const receiverUrl = "{{ receiver_url }}";  // e.g. "http://192.168.0.10:8000"
        // Derive WebSocket URL (assumes same host, port 8000)
        const wsUrl = receiverUrl.replace(/^http/, "ws") + "/ws/status";
        let ws;

        function initWebSocket() {
            ws = new WebSocket(wsUrl);

            ws.onopen = () => {
            console.log("WebSocket connected to", wsUrl);
            // Optionally request an explicit status
            ws.send("get_status");
            };

            ws.onmessage = event => {
            try {
                const msg = JSON.parse(event.data);
                if (msg.type === "status") {
                const st = msg.data;
                applyStatusToUI(st);
                }
            } catch (e) {
                console.error("Invalid WS message", e, event.data);
            }
            };

            ws.onclose = () => {
            console.log("WebSocket closed. Reconnecting in 1s...");
            setTimeout(initWebSocket, 1000);
            };

            ws.onerror = err => {
            console.error("WebSocket error", err);
            ws.close();
            };
        }

        // UI event handlers (same as before)
        document.getElementById("runBtn").onclick = async () => {
            const code = document.getElementById("codeInput").value;
            if (!code.trim()) return alert("Code is empty.");
            await sendCommand("type", code);
        };

        document.getElementById("pauseBtn").onclick = async () => {
            const status = await getStatus();
            const action = status.paused ? "resume" : "pause";
            await sendCommand(action);
            // UI update will come via WebSocket or fallback
        };

        document.getElementById("randomBtn").onclick = async () => {
            await sendCommand("toggle_random");
        };

        document.getElementById("stopBtn").onclick = async () => {
            await sendCommand("stop");
        };

        async function sendCursorCommand(cmd) {
            let count = document.getElementById(cmd + "Count").value;
            await sendCommand(cmd, parseInt(count));
        }

        async function sendCommand(action, data = null) {
            const res = await fetch(`${receiverUrl}/command`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ action, data }),
            });
            return await res.json();
        }

        async function getStatus() {
            const res = await fetch(`${receiverUrl}/status`);
            return await res.json();
        }

        function applyStatusToUI(status) {
            document.getElementById("pauseBtn").textContent = status.paused ? "Resume" : "Pause";
            document.getElementById("randomBtn").textContent = `Random: ${status.randomize ? "On" : "Off"}`;
            document.getElementById("autoPauseToggle").checked = status.auto_pause_after_line;
            // You could also disable/enable buttons depending on state, etc.
        }

        function toggleAutoPause() {
            sendCommand("toggle_auto_pause");
        }

        window.onload = () => {
            initWebSocket();
            // In case WebSocket misses initial status, also fetch once
            getStatus().then(applyStatusToUI);
        };
    </script>

</body>
</html>
