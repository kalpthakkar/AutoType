<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AutoTyper Sender</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 text-gray-900 font-sans min-h-screen flex flex-col">
    <main class="w-full max-w-[85%] mx-auto px-20 pt-10 pb-10 bg-white shadow-lg rounded-lg mt-12 mb-16 flex-grow">
    <h1 class="text-3xl font-extrabold text-center mb-8 tracking-tight">AutoTyper Sender</h1>

    <section class="mb-4">
    <div class="relative flex w-full rounded-md border border-gray-300 bg-white focus-within:ring-2 focus-within:ring-indigo-500 focus-within:border-indigo-500 transition-shadow duration-200">
        <!-- Line Numbers -->
        <div id="lineNumbers"
            class="overflow-hidden text-right pr-3 pt-3 pb-3 text-gray-400 bg-gray-100 border border-gray-300 rounded-l-md select-none font-mono text-sm leading-6 whitespace-pre"
            style="min-width: 2.5rem;">
        1
        </div>
        <!-- Textarea -->
        <textarea
        id="codeInput"
        wrap="off"
        rows="10"
        placeholder="Enter code or message here..."
        class="w-full p-3 resize-y placeholder-gray-400 bg-white focus:outline-none font-mono text-sm leading-6 overflow-x-auto"
        oninput="updateLineNumbers()"
        onscroll="syncScroll()"
        ></textarea>
    </div>
    </section>


    <section class="mb-8 flex flex-wrap justify-center gap-4">
      <button
        id="runBtn"
        class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-md shadow-md
               focus:outline-none focus:ring-2 focus:ring-green-400 focus:ring-offset-1 transition"
      >
        Run
      </button>
      <button
        id="pauseBtn"
        class="bg-yellow-500 hover:bg-yellow-600 text-white px-6 py-2 rounded-md shadow-md
               focus:outline-none focus:ring-2 focus:ring-yellow-400 focus:ring-offset-1 transition"
      >
        Pause
      </button>
      <button
        id="randomBtn"
        class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-md shadow-md
               focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-offset-1 transition"
      >
        Humanize: On
      </button>
      <button
        id="stopBtn"
        class="bg-red-600 hover:bg-red-700 text-white px-6 py-2 rounded-md shadow-md
               focus:outline-none focus:ring-2 focus:ring-red-400 focus:ring-offset-1 transition"
      >
        Stop
      </button>
    </section>

    <div class="flex flex-col md:flex-row gap-6 max-w-4xl mx-auto mb-4">

        <!-- Auto Pause & Normalize Section -->
        <section class="bg-white border border-gray-200 rounded-lg p-4 shadow-sm w-full max-w-md flex flex-col justify-center gap-4">
            <div class="flex items-center justify-between mb-2">
                <div class="flex items-center gap-2">
                    <h2 class="text-xl font-semibold text-gray-900">Auto Pause</h2>

                    <!-- Tooltip icon -->
                    <div class="relative group">
                    <button
                        type="button"
                        class="text-gray-400 hover:text-gray-600 focus:outline-none"
                        aria-label="Info"
                    >
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none"
                        viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M13 16h-1v-4h-1m1-4h.01M12 20c4.418 0 8-3.582 8-8s-3.582-8-8-8-8 3.582-8 8 3.582 8 8 8z" />
                        </svg>
                    </button>

                    <!-- Tooltip content -->
                    <div
                        class="absolute top-full left-1/2 -translate-x-1/2 mt-1 w-56 text-sm text-white bg-gray-800 rounded px-3 py-2 shadow-lg opacity-0 group-hover:opacity-100 transition-opacity duration-200 z-10 pointer-events-none">
                        Pause automatically after each line.
                    </div>
                    </div>
                </div>
                <!-- Toggle Switch -->
                <label class="relative inline-flex items-center cursor-pointer" for="autoPauseToggle">
                    <input
                    type="checkbox"
                    id="autoPauseToggle"
                    class="sr-only peer"
                    onchange="toggleAutoPause()"
                    aria-label="Auto Pause After Each Line"
                    />
                    <div
                    class="w-12 h-7 bg-gray-200 rounded-full peer-checked:bg-indigo-600 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-indigo-400 transition-colors duration-200"
                    ></div>
                    <span
                    class="absolute left-0.5 top-0.5 w-6 h-6 bg-white border border-gray-300 rounded-full shadow-md
                            transform peer-checked:translate-x-5 peer-checked:border-transparent
                            transition-transform duration-200 will-change-transform"
                    aria-hidden="true"
                    ></span>
                </label>
            </div>
            <div class="flex items-center justify-between mb-2">
                <div class="flex items-center gap-2">
                <h2 class="text-xl font-semibold text-gray-900">Normalize</h2>

                <!-- Tooltip icon -->
                <div class="relative group">
                    <button
                    type="button"
                    class="text-gray-400 hover:text-gray-600 focus:outline-none"
                    aria-label="Info"
                    >
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none"
                        viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M13 16h-1v-4h-1m1-4h.01M12 20c4.418 0 8-3.582 8-8s-3.582-8-8-8-8 3.582-8 8 3.582 8 8 8z" />
                    </svg>
                    </button>

                    <!-- Tooltip content -->
                    <div
                    class="absolute top-full left-1/2 -translate-x-1/2 mt-1 w-64 text-sm text-white bg-gray-800 rounded px-3 py-2 shadow-lg opacity-0 group-hover:opacity-100 transition-opacity duration-200 z-10 pointer-events-none">
                    Each line ignores leading spaces or tabs before typing.
                    </div>
                </div>
                </div>
                <!-- Toggle Switch -->
                <label class="relative inline-flex items-center cursor-pointer" for="normalizeToggle">
                <input
                    type="checkbox"
                    id="normalizeToggle"
                    class="sr-only peer"
                    onchange="toggleNormalize()"
                    aria-label="Normalize Leading Whitespace"
                />
                <div
                    class="w-12 h-7 bg-gray-200 rounded-full peer-checked:bg-indigo-600 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-indigo-400 transition-colors duration-200"
                ></div>
                <span
                    class="absolute left-0.5 top-0.5 w-6 h-6 bg-white border border-gray-300 rounded-full shadow-md
                        transform peer-checked:translate-x-5 peer-checked:border-transparent
                        transition-transform duration-200 will-change-transform"
                    aria-hidden="true"
                ></span>
                </label>
            </div>
        </section>

        <!-- Typing Speed Section -->
        <section class="bg-white border border-gray-200 rounded-lg p-4 shadow-sm w-full max-w-md">
            <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-2">
                <h2 class="text-xl font-semibold text-gray-900">Typing Speed (seconds)</h2>

                <!-- Tooltip icon -->
                <div class="relative group">
                <button
                    type="button"
                    class="text-gray-400 hover:text-gray-600 focus:outline-none"
                    aria-label="Info"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none"
                    viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M13 16h-1v-4h-1m1-4h.01M12 20c4.418 0 8-3.582 8-8s-3.582-8-8-8-8 3.582-8 8 3.582 8 8 8z" />
                    </svg>
                </button>

                <!-- Tooltip content -->
                <div
                    class="absolute top-full left-1/2 -translate-x-1/2 mt-1 w-56 text-sm text-white bg-gray-800 rounded px-3 py-2 shadow-lg opacity-0 group-hover:opacity-100 transition-opacity duration-200 z-10 pointer-events-none"
                >
                    Random typing delay is used when <strong>Humanize</strong> is enabled.
                </div>
                </div>
            </div>
            </div>

            <div class="flex flex-wrap items-end gap-4">
            <div class="flex flex-col">
                <label for="minSpeed" class="text-sm font-medium text-gray-700 mb-1">Min</label>
                <input
                type="number"
                id="minSpeed"
                min="0.1"
                step="0.1"
                value="0.5"
                class="w-24 px-3 py-2 border border-gray-300 rounded-md text-center focus:outline-none focus:ring-2 focus:ring-indigo-500"
                />
            </div>

            <div class="flex flex-col">
                <label for="maxSpeed" class="text-sm font-medium text-gray-700 mb-1">Max</label>
                <input
                type="number"
                id="maxSpeed"
                min="0.1"
                step="0.1"
                value="1.5"
                class="w-24 px-3 py-2 border border-gray-300 rounded-md text-center focus:outline-none focus:ring-2 focus:ring-indigo-500"
                />
            </div>

            <div class="flex-grow">
                <button
                onclick="updateSpeedRange()"
                class="mt-5 sm:mt-0 w-full sm:w-auto bg-indigo-600 hover:bg-indigo-700 text-white font-medium px-5 py-2 rounded-md shadow transition focus:outline-none focus:ring-2 focus:ring-indigo-500"
                >
                Apply
                </button>
            </div>
            </div>
        </section>
    </div>

  </main>

    <script>

        const textarea = document.getElementById("codeInput");
        const lineNumbers = document.getElementById("lineNumbers");

        const resizeObserver = new ResizeObserver(() => {
        lineNumbers.style.height = `${textarea.clientHeight}px`;
        });

        resizeObserver.observe(textarea);

        textarea.addEventListener("scroll", () => {
        lineNumbers.scrollTop = textarea.scrollTop;
        });

        window.addEventListener("DOMContentLoaded", () => {
            updateLineNumbers();  // initialize once
        });

        function updateLineNumbers() {
            const textarea = document.getElementById("codeInput");
            const lineNumbers = document.getElementById("lineNumbers");

            const lines = textarea.value.split("\n").length || 1;
            lineNumbers.textContent = Array.from({ length: lines }, (_, i) => i + 1).join("\n");
        }

        document.getElementById("codeInput").addEventListener("input", updateLineNumbers);

        function syncScroll() {
        const textarea = document.getElementById('codeInput');
        const lineNumbers = document.getElementById('lineNumbers');
        lineNumbers.scrollTop = textarea.scrollTop;
        }

        // Initial render on page load
        window.onload = updateLineNumbers;
    </script>


    <script>
        const receiverUrl = "{{ receiver_url }}";  // e.g. "http://192.168.0.10:8000"
        // Derive WebSocket URL (assumes same host, port 8000)
        const wsUrl = receiverUrl.replace(/^http/, "ws") + "/ws/status";
        let ws;

        function initWebSocket() {
            ws = new WebSocket(wsUrl);

            ws.onopen = () => {
            console.log("WebSocket connected to", wsUrl);
            // Optionally request an explicit status
            ws.send("get_status");
            };

            ws.onmessage = event => {
            try {
                const msg = JSON.parse(event.data);
                if (msg.type === "status") {
                const st = msg.data;
                applyStatusToUI(st);
                }
            } catch (e) {
                console.error("Invalid WS message", e, event.data);
            }
            };

            ws.onclose = () => {
            console.log("WebSocket closed. Reconnecting in 1s...");
            setTimeout(initWebSocket, 1000);
            };

            ws.onerror = err => {
            console.error("WebSocket error", err);
            ws.close();
            };
        }

        async function updateSpeedRange() {
            const min = parseFloat(document.getElementById("minSpeed").value);
            const max = parseFloat(document.getElementById("maxSpeed").value);

            if (isNaN(min) || isNaN(max) || min <= 0 || min > max) {
                alert("Invalid speed range. Ensure Min > 0 and Min â‰¤ Max.");
                return;
            }

            try {
                await fetch(`${receiverUrl}/set_speed`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ min, max })
                });
            } catch (e) {
                console.error("Failed to update speed range", e);
            }
        }

        // UI event handlers (same as before)
        document.getElementById("runBtn").onclick = async () => {
            const code = document.getElementById("codeInput").value;
            if (!code.trim()) return alert("Code is empty.");
            await sendCommand("type", code);
        };

        document.getElementById("pauseBtn").onclick = async () => {
            const status = await getStatus();
            const action = (status.paused) ? "resume" : "pause";
            await sendCommand(action);
            // UI update will come via WebSocket or fallback
            const updateStatus = await getStatus()
            applyStatusToUI(updateStatus)
        };

        document.getElementById("randomBtn").onclick = async () => {
            await sendCommand("toggle_random");
            const updateStatus = await getStatus()
            applyStatusToUI(updateStatus)
        };

        document.getElementById("stopBtn").onclick = async () => {
            await sendCommand("stop");
        };

        async function sendCommand(action, data = null) {
            const res = await fetch(`${receiverUrl}/command`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ action, data }),
            });
            return await res.json();
        }

        async function getStatus() {
            const res = await fetch(`${receiverUrl}/status`);
            return await res.json();
        }

        function applyStatusToUI(status) {

            document.getElementById("minSpeed").value = status.speed_min.toFixed(1);
            document.getElementById("maxSpeed").value = status.speed_max.toFixed(1);

            const pauseBtn = document.getElementById("pauseBtn");
            const randomBtn = document.getElementById("randomBtn");
            const queueSize = status.queue_size || 0;

            // Label logic
            pauseBtn.textContent = (status.paused && status.queue_size > 0) ? "Resume" : "Pause";
            randomBtn.textContent = `Humanize: ${status.randomize ? "On" : "Off"}`;
            document.getElementById("autoPauseToggle").checked = status.auto_pause_after_line;
            document.getElementById("normalizeToggle").checked = status.normalize;

            // Disable pause button if there's nothing to pause or resume
            pauseBtn.disabled = (status.queue_size === 0);

            // Add disabled style manually (for visual effect)
            if (pauseBtn.disabled) {
                pauseBtn.classList.add("opacity-50", "cursor-not-allowed");
            } else {
                pauseBtn.classList.remove("opacity-50", "cursor-not-allowed");
            }
        }

        function toggleAutoPause() {
            sendCommand("toggle_auto_pause");
        }

        function toggleNormalize() {
            sendCommand("toggle_normalize");
        }

        window.onload = () => {
            initWebSocket();
            // In case WebSocket misses initial status, also fetch once
            getStatus().then(applyStatusToUI);
        };
    </script>

</body>
</html>
